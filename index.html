<!doctype html>
<html lang="th">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô KPI</title>

<script src="https://cdn.tailwindcss.com"></script>

<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>

body{
font-family:'Sarabun',sans-serif;
height:100vh;
background:#f3f4f6;
display:flex;
align-items:center;
justify-content:center;
}

.main-card{
background:white;
border-radius:20px;
box-shadow:0 20px 25px rgba(0,0,0,.08);
max-width:950px;
width:100%;
display:flex;
overflow:hidden;
}

.login-section{padding:3rem;flex:1;}

.info-section{
background:linear-gradient(135deg,#667eea,#764ba2);
color:white;
padding:2rem;
flex:.9;
}

.form-input{
width:100%;
padding:.7rem;
border:2px solid #e5e7eb;
border-radius:8px;
}

.btn-primary{
width:100%;
background:linear-gradient(to right,#4f46e5,#7c3aed);
color:white;
padding:.9rem;
border-radius:8px;
font-weight:bold;
}

.event-item{
background:rgba(255,255,255,.1);
padding:.7rem;
border-radius:8px;
margin-bottom:.6rem;
display:flex;
border-left:4px solid #fbbf24;
}

.today{
border-left:4px solid #22c55e;
background:rgba(34,197,94,.2);
}

</style>
</head>

<body>

<div class="main-card">

<div class="login-section">

<h1 class="text-2xl font-bold mb-6 text-center">
‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô KPI
</h1>

<form onsubmit="checkPassword(event)">

<label class="font-bold text-sm">
‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å KPI
</label>

<select id="login-month"
class="form-input mt-1 mb-4"
onchange="updateCalendar()">
</select>

<label class="font-bold text-sm">
‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß
</label>

<input type="password"
id="login-password"
class="form-input text-center mt-1"
required>

<p id="error-msg"
class="text-red-500 hidden font-bold text-center mt-2">
‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
</p>

<button class="btn-primary mt-4">
‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
</button>

</form>

</div>


<div class="info-section">

<div class="flex justify-between mb-3">
<h2 class="font-bold">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</h2>

<span id="calendar-month-label"
class="bg-white text-indigo-700 px-2 rounded">
</span>
</div>

<div id="calendar-container">
‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
</div>

<div id="no-events-msg"
class="hidden text-center opacity-70 mt-6">
‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
</div>

</div>

</div>

<script>

// üî• ‡πÉ‡∏™‡πà URL /exec
const API_URL="https://script.google.com/macros/s/AKfycbxXPg_A-8lLZWMllH6s_VUPQ2BVXu88rxW-kg5TcvxDQRBRjxXd9oKN_q1LI-ksfqZBZw/exec";

let allEvents=[];
let calendarMonth;
let reportMonth;

const thaiMonths=[
"‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô",
"‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô","‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°",
"‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
];

document.addEventListener('DOMContentLoaded',init);

async function init(){

try{

const configReq = fetch(API_URL+"?type=config");
const calReq = fetch(API_URL+"?type=calendar");

const [configRes,calRes]=await Promise.all([
configReq,calReq
]);

const config=await configRes.json();
allEvents=await calRes.json();

calendarMonth=config.calendarMonth;
reportMonth=config.reportMonth;

generateDropdown();
updateCalendar(calendarMonth);

}catch(err){

alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
console.error(err);

}

}


// =================
// DROPDOWN
// =================

function generateDropdown(){

const select=document.getElementById('login-month');

for(let i=1;i<=12;i++){

const opt=document.createElement("option");
opt.value=i;
opt.textContent=thaiMonths[i-1];
select.appendChild(opt);

}

select.value=reportMonth;

}


// =================
// CALENDAR
// =================

function updateCalendar(monthOverride){

const monthId = monthOverride ??
parseInt(document.getElementById('login-month').value);

document.getElementById('calendar-month-label')
.textContent=thaiMonths[monthId-1];

const container=document.getElementById('calendar-container');
const noEvents=document.getElementById('no-events-msg');

const today=new Date().getDate();

const events=allEvents.filter(e=>e.monthId==monthId);

if(!events.length){

container.innerHTML="";
noEvents.classList.remove('hidden');
return;

}

noEvents.classList.add('hidden');

container.innerHTML=events.map(evt=>`

<div class="event-item ${evt.day==today?'today':''}">
<div class="mr-3 font-bold">${evt.day}</div>

<div>
<div class="font-bold">${evt.title}</div>
<div class="text-sm">${evt.time}</div>
<div class="text-xs">${evt.location??''}</div>
</div>

</div>

`).join('');

}


// =================
// LOGIN ‚≠ê FIX ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
// =================

async function checkPassword(e){

e.preventDefault();

document
.getElementById('error-msg')
.classList.add('hidden');

const password=document
.getElementById('login-password')
.value.trim();

const month=document
.getElementById('login-month').value;

try{

const res=await fetch(API_URL,{

method:"POST",

headers:{
"Content-Type":"application/json" // üî• ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å
},

body:JSON.stringify({
type:"login",
password,
month
})

});

const data=await res.json();

if(!data.success){

document
.getElementById('error-msg')
.classList.remove('hidden');

return;

}

// redirect
window.location.href=data.link;

}catch(err){

alert("Login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
console.error(err);

}

}

</script>

</body>
</html>
